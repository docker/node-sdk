name: Publish Package to NPM

on:
    push:
        tags:
            - 'v*'

permissions:
    id-token: write  # Required for NPM Trusted Publishers
    contents: read

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v5

            # Uses NPM Trusted Publishers for access to the registry
            # See https://docs.npmjs.com/trusted-publishers
            - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 #v4.0.3
              with:
                  node-version-file: .node-version
                  registry-url: 'https://registry.npmjs.org'

            # Ensure npm 11.5.1 or later is installed
            - name: Update npm
              run: npm install -g npm@latest
            - run: npm ci
            - run: npm run build --if-present
            - run: npm test
            - run: npm publish --provenance --access public